<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supervisor Portal</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); min-height: 100vh; }

        /* ‚îÄ‚îÄ Login ‚îÄ‚îÄ */
        #loginScreen { min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .login-container { background: #fff; border-radius: 20px; padding: 50px 40px; box-shadow: 0 20px 60px rgba(0,0,0,.3); max-width: 450px; width: 100%; }
        .login-header { text-align: center; margin-bottom: 40px; }
        .login-icon { font-size: 4em; margin-bottom: 15px; }
        .login-header h1 { color: #333; margin-bottom: 10px; font-size: 2em; }
        .login-header p { color: #666; }
        .form-group { margin-bottom: 25px; }
        .form-group label { display: block; color: #333; font-weight: 600; margin-bottom: 8px; }
        .form-group input { width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; transition: border-color .3s; }
        .form-group input:focus { outline: none; border-color: #43e97b; }
        .login-btn { width: 100%; padding: 15px; background: linear-gradient(135deg,#43e97b,#38f9d7); color: #fff; border: none; border-radius: 10px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: transform .3s, box-shadow .3s; margin-top: 10px; }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(67,233,123,.4); }
        .error-message { background: #fee; color: #c33; padding: 12px; border-radius: 8px; margin-bottom: 20px; text-align: center; display: none; border: 1px solid #fcc; }
        .back-link { text-align: center; margin-top: 20px; }
        .back-link a { color: #666; text-decoration: none; }
        .back-link a:hover { color: #43e97b; }

        /* ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ */
        #dashboard { display: none; background: #f5f7fa; min-height: 100vh; }
        #dashboard.active { display: block; }
        .dashboard-container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .dashboard-header { background: #fff; border-radius: 15px; padding: 30px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,.1); display: flex; justify-content: space-between; align-items: center; }
        .user-info h2 { color: #333; margin-bottom: 5px; }
        .user-info p { color: #666; }
        .logout-btn { background: rgba(67,233,123,.2); color: #2d8a56; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600; }
        .logout-btn:hover { background: rgba(67,233,123,.3); }

        /* ‚îÄ‚îÄ Summary Cards ‚îÄ‚îÄ */
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap: 20px; margin-bottom: 30px; }
        .summary-card { background: #fff; border-radius: 15px; padding: 25px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,.05); }
        .summary-card .icon { font-size: 2em; margin-bottom: 10px; }
        .summary-card .value { font-size: 2em; font-weight: 700; color: #333; }
        .summary-card .label { color: #666; font-size: .9em; margin-top: 5px; }

        /* ‚îÄ‚îÄ Tab Navigation ‚îÄ‚îÄ */
        .tab-nav { display: flex; gap: 0; margin-bottom: 30px; background: #fff; border-radius: 15px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,.1); }
        .tab-btn { flex: 1; padding: 20px; text-align: center; cursor: pointer; font-size: 1.1em; font-weight: 600; color: #666; border: none; background: #fff; transition: all .3s; border-bottom: 3px solid transparent; }
        .tab-btn:hover { background: #f9f9f9; color: #333; }
        .tab-btn.active { color: #2d8a56; border-bottom-color: #43e97b; background: linear-gradient(180deg,#f0fdf4,#fff); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* ‚îÄ‚îÄ Sections ‚îÄ‚îÄ */
        .section-card { background: #fff; border-radius: 15px; padding: 30px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,.1); }
        .section-card h3 { color: #333; margin-bottom: 25px; font-size: 1.4em; display: flex; align-items: center; gap: 10px; }

        /* ‚îÄ‚îÄ Tables ‚îÄ‚îÄ */
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table thead { background: linear-gradient(135deg,#f0fdf4,#e8f5e9); }
        .data-table th { padding: 14px 12px; text-align: left; color: #333; font-weight: 600; font-size: .9em; white-space: nowrap; }
        .data-table td { padding: 14px 12px; border-bottom: 1px solid #f0f0f0; color: #555; font-size: .9em; }
        .data-table tbody tr:hover { background: #f9f9f9; }
        .total-row { background: linear-gradient(135deg,#f0fdf4,#e8f5e9); font-weight: 700; }
        .total-row td { padding: 18px 12px; border-bottom: none; }
        .no-data { text-align: center; padding: 40px; color: #999; font-style: italic; }
        .sales-val { color: #2d8a56; font-weight: 600; }
        .pct-badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-weight: 600; font-size: .85em; }
        .pct-high { background: #d4edda; color: #155724; }
        .pct-mid { background: #fff3cd; color: #856404; }
        .pct-low { background: #f8d7da; color: #721c24; }

        /* ‚îÄ‚îÄ Toolbar ‚îÄ‚îÄ */
        .toolbar { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-bottom: 20px; }
        .toolbar input[type="text"] { padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: .95em; min-width: 200px; }
        .toolbar input:focus,.toolbar select:focus { outline: none; border-color: #43e97b; }
        .toolbar select { padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: .9em; background: #fff; cursor: pointer; }
        .toolbar label { font-size: .85em; color: #666; font-weight: 600; }
        .toolbar-group { display: flex; align-items: center; gap: 6px; }

        .group-header-row td { background: linear-gradient(135deg,#e8f5e9,#f1f8e9); font-weight: 700; color: #333; padding: 12px; border-bottom: 2px solid #43e97b; }
        .group-subtotal-row td { background: #fafafa; font-weight: 600; color: #555; font-style: italic; border-bottom: 2px solid #e0e0e0; }

        .rating-stars{color:#43e97b;font-weight:700}
        .photo-link{color:#2d8a56;font-size:.8em;margin-right:6px;text-decoration:none}
        .photo-link:hover{text-decoration:underline}
        .photo-count-badge{background:#e8f5e9;color:#2d8a56;padding:3px 10px;border-radius:10px;font-size:.8em;font-weight:600}
        .survey-count-card{background:#fff;border-radius:15px;padding:25px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,.05)}
        .survey-loading{text-align:center;padding:30px;color:#999}

        /* ‚îÄ‚îÄ Progress bar in table ‚îÄ‚îÄ */
        .mini-progress { width: 80px; height: 8px; background: #e0e0e0; border-radius: 4px; display: inline-block; vertical-align: middle; margin-left: 8px; }
        .mini-progress-fill { height: 100%; border-radius: 4px; background: linear-gradient(90deg,#43e97b,#38f9d7); }

        @media(max-width:768px){ .dashboard-header{flex-direction:column;gap:20px;text-align:center} .summary-grid{grid-template-columns:1fr 1fr} .toolbar{flex-direction:column;align-items:stretch} .toolbar input[type="text"]{min-width:auto;width:100%} .tab-btn{font-size:.9em;padding:15px 10px} }
        .cust-summary-row{cursor:pointer;transition:background 0.15s;}
        .cust-summary-row:hover{background:#e8f5e9 !important;}
        .cust-summary-row td:first-child{text-align:center;font-size:0.85em;color:#888;}
        .var-positive{color:#2e7d32;font-weight:600;}
        .var-negative{color:#c62828;font-weight:600;}
        th.sortable{cursor:pointer;user-select:none;position:relative;padding-right:20px !important;}
        th.sortable::after{content:'‚áÖ';position:absolute;right:4px;top:50%;transform:translateY(-50%);opacity:0.3;font-size:0.75em;}
        th.sortable.sort-asc::after{content:'‚ñ≤';opacity:0.8;color:#2e7d32;}
        th.sortable.sort-desc::after{content:'‚ñº';opacity:0.8;color:#2e7d32;}
        th.sortable:hover{background:rgba(0,0,0,0.04);}
    </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
    <div class="login-container">
        <div class="login-header"><div class="login-icon">üë®‚Äçüíº</div><h1>Supervisor Login</h1><p>Enter your credentials to continue</p></div>
        <div id="errorMessage" class="error-message"></div>
        <form id="loginForm">
            <div class="form-group"><label for="userName">User Name</label><input type="text" id="userName" placeholder="e.g. SUP" required></div>
            <div class="form-group"><label for="userCode">User ID</label><input type="text" id="userCode" placeholder="e.g. 123456" required></div>
            <button type="submit" class="login-btn">Log In</button>
        </form>
        <div class="back-link"><a href="index.html">‚Üê Back to Role Selection</a></div>
    </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">
    <div class="dashboard-container">
        <div class="dashboard-header">
            <div class="user-info"><h2>Welcome, <span id="dashName"></span>!</h2><p>Supervisor ID: <span id="dashCode"></span></p></div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <!-- Summary -->
        <div class="summary-grid">
            <div class="summary-card"><div class="icon">üë•</div><div class="value" id="sumSalesmen">0</div><div class="label">Total Salesmen</div></div>
            <div class="summary-card"><div class="icon">üéØ</div><div class="value" id="sumTarget">0</div><div class="label">Total Target (SAR)</div></div>
            <div class="summary-card"><div class="icon">üí∞</div><div class="value" id="sumActual">0</div><div class="label">Total Actual (SAR)</div></div>
            <div class="summary-card"><div class="icon">üìä</div><div class="value" id="sumPct">0%</div><div class="label">Overall Achievement</div></div>
            <div class="summary-card"><div class="icon">üè™</div><div class="value" id="sumCustomers">0</div><div class="label">Total Customers</div></div>
            <div class="summary-card"><div class="icon">üìã</div><div class="value" id="sumSurveys">0</div><div class="label">Total Surveys</div></div>
        </div>

        <!-- Tabs -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('salesmen')">üë• My Salesmen</button>
            <button class="tab-btn" onclick="switchTab('customers')">üè™ All Customers</button>
            <button class="tab-btn" onclick="switchTab('surveys')">üìã Surveys</button>
        </div>

        <!-- TAB 1: My Salesmen -->
        <div id="tab-salesmen" class="tab-content active">
            <div class="section-card">
                <h3>üë• My Salesmen ‚Äî Performance Overview</h3>
                <table class="data-table">
                    <thead><tr><th class="sortable" data-sort="salesmanCode" data-table="sm">Code</th><th class="sortable" data-sort="salesman" data-table="sm">Salesman</th><th class="sortable" data-sort="routeCode" data-table="sm">Route</th><th class="sortable" data-sort="tgt" data-table="sm">Target</th><th class="sortable" data-sort="actCY" data-table="sm">Actual</th><th class="sortable" data-sort="pctTgt" data-table="sm">%TGT</th><th class="sortable" data-sort="remaining" data-table="sm">Remaining</th><th>Progress</th></tr></thead>
                    <tbody id="salesmenTableBody"><tr><td colspan="8" class="no-data">Loading‚Ä¶</td></tr></tbody>
                    <tfoot><tr class="total-row"><td colspan="3">Total</td><td class="sales-val" id="smTotalTgt">0</td><td class="sales-val" id="smTotalAct">0</td><td class="sales-val" id="smTotalPct">0%</td><td class="sales-val" id="smTotalRem">0</td><td></td></tr></tfoot>
                </table>
            </div>
        </div>

        <!-- TAB 2: All Customers -->
        <div id="tab-customers" class="tab-content">
            <div class="section-card">
                <h3>üè™ All Customer Sales</h3>
                <div class="toolbar">
                    <input type="text" id="custSearch" placeholder="üîç Search...">
                    <div class="toolbar-group"><label>Salesman:</label><select id="filtSalesman"><option value="">All</option></select></div>
                    <div class="toolbar-group"><label>Customer Code:</label><select id="filtCustCode"><option value="">All</option></select></div>
                    <div class="toolbar-group"><label>Customer:</label><select id="filtCustomer"><option value="">All</option></select></div>
                    <div class="toolbar-group"><label>Route:</label><select id="filtRoute"><option value="">All</option></select></div>
                </div>
                <table class="data-table" id="custTable">
                    <thead><tr><th style="width:30px"></th><th class="sortable" data-sort="code">Code</th><th class="sortable" data-sort="customer">Customer</th><th class="sortable" data-sort="salesman">Salesman</th><th class="sortable" data-sort="routeCode">Route</th><th class="sortable" data-sort="totalCY">ACT-CY</th><th class="sortable" data-sort="totalLY">ACT-LY</th><th class="sortable" data-sort="varPct">Var %</th></tr></thead>
                    <tbody id="custTableBody"><tr><td colspan="8" class="no-data">Loading‚Ä¶</td></tr></tbody>
                    <tfoot><tr class="total-row"><td colspan="5">Total</td><td class="sales-val"><span id="custTotalCY">0</span></td><td class="sales-val"><span id="custTotalLY">0</span></td><td></td></tr></tfoot>
                </table>
            </div>
        </div>

        <!-- TAB 3: Surveys -->
        <div id="tab-surveys" class="tab-content">
            <div class="section-card">
                <h3>üìã Salesman Surveys</h3>
                <div class="toolbar">
                    <input type="text" id="surveySearch" placeholder="üîç Search surveys...">
                    <div class="toolbar-group"><label>Salesman:</label><select id="survFiltSM"><option value="">All</option></select></div>
                    <div class="toolbar-group"><label>Customer:</label><select id="survFiltCust"><option value="">All</option></select></div>
                    <div class="toolbar-group"><label>Rating:</label><select id="survFiltRating"><option value="">All</option><option value="low">1-4 (Low)</option><option value="mid">5-7 (Medium)</option><option value="high">8-10 (High)</option></select></div>
                    <div class="toolbar-group"><label>Sort:</label><select id="survSortBy"><option value="">Latest First</option><option value="rating-desc">Rating ‚Üì</option><option value="rating-asc">Rating ‚Üë</option><option value="salesman-asc">Salesman ‚Üë</option><option value="customer-asc">Customer ‚Üë</option></select></div>
                </div>
                <div id="surveyTableContainer"><p class="survey-loading">Loading surveys...</p></div>
            </div>
        </div>

    </div>
</div>

<script>
// ‚ïê‚ïê GOOGLE APPS SCRIPT CONFIG (smart filtered API) ‚ïê‚ïê
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwXDjuyI5j2l8XP1iMkGQ5lXROrNztr77ca0HZCyzWOv6LeGq7eIGU1dvCNWr3q9JtP/exec';
// ‚ïê‚ïê POWER AUTOMATE CONFIG (surveys only) ‚ïê‚ïê
const POWER_AUTOMATE_GET_URL = 'https://default04af0493a5b44947ab72ae37fae884.14.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/a52eaf1a49894199856439aa7e837f82/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=TKq2xFQ8rgo4juZL9h8SoNrPOH-gEe24DIOd7Jsu0Qw';

let usersData=[],salesmenData=[],masterData=[],currentUser=null,mySalesmen=[],myMasterData=[];
let allSurveys=[];

function sanitize(s){const d=document.createElement('div');d.textContent=String(s);return d.innerHTML;}
function toNum(v){const n=Number(v);return isNaN(n)?0:n;}

async function loadFromAppsScript(userCode){
    if(!APPS_SCRIPT_URL)return false;
    try{
        const url=APPS_SCRIPT_URL+'?action=login&code='+encodeURIComponent(userCode);
        const r=await fetch(url);if(!r.ok)return false;
        const data=await r.json();if(data.error)return false;
        if(data.user)usersData=[{userCode:String(data.user['User Code']||''),userName:data.user['User Name']||'',role:data.user.Role||''}];
        if(data.salesmenData)salesmenData=data.salesmenData.map(r=>({salesmanCode:String(r['Salesman Code']||''),salesman:r['Salesman']||'',assignedSUP:String(r['Assigned SUP']||''),routeCode:String(r['Route Code']||''),tgt:toNum(r['TGT']),actCY:toNum(r['ACT-CY']),pctTgt:toNum(r['%TGT'])}));
        if(data.masterData)masterData=data.masterData.map(r=>({supervisorCode:String(r['Supervisor Code']||''),salesmanCode:String(r['Salesman Code']||''),branchManager:r['Branch Manager']||'',routeCode:String(r['Route Code']||''),customerCode:String(r['Customer Code']||''),customer:r['Customer']||'',sector:r['Sector']||'',cls:r['Class']||'',region:r['Region']||'',branch:r['Branch']||'',brand:r['Brand']||'',productGroup:r['Product Group']||'',subBrand:r['Sub Brand']||'',product:r['Product']||'',dayDate:String(r['Date']||'').substring(0,10),l3s:toNum(r['L3S']),l6s:toNum(r['L6S']),achCYP:toNum(r['ACH CY (P)']),achLYP:toNum(r['ACH LY (P)']),actCY:toNum(r['ACT-CY']),actLY:toNum(r['ACT-LY'])}));
        console.log('Apps Script: loaded',salesmenData.length,'salesmen,',masterData.length,'master rows');
        return true;
    }catch(e){console.error('Apps Script error:',e);return false;}
}

async function loadData(){
    try{/* JSON fallback disabled ‚Äî using Apps Script */throw 'skip';}catch(e){
    
    usersData=[{"userCode":75241,"userName":"Aseel","role":"Salesman"},{"userCode":75242,"userName":"Ali","role":"Salesman"},{"userCode":75243,"userName":"Ahmed","role":"Salesman"},{"userCode":75244,"userName":"Amer","role":"Salesman"},{"userCode":75245,"userName":"Amjad","role":"Salesman"},{"userCode":12345,"userName":"Admin","role":"Management"},{"userCode":123456,"userName":"SUP","role":"Supervisor"},{"userCode":3001,"userName":"BSM","role":"BSM"}];
    salesmenData=[{"salesmanCode":75241,"salesman":"Aseel","routeCode":1,"assignedSUP":123456,"tgt":3000,"actCY":2700,"pctTgt":90},{"salesmanCode":75242,"salesman":"Ali","routeCode":2,"assignedSUP":123456,"tgt":3200,"actCY":3000,"pctTgt":93.75},{"salesmanCode":75243,"salesman":"Ahmed","routeCode":3,"assignedSUP":123456,"tgt":3100,"actCY":2800,"pctTgt":90.32},{"salesmanCode":75244,"salesman":"Amer","routeCode":4,"assignedSUP":123456,"tgt":3500,"actCY":2700,"pctTgt":77.14},{"salesmanCode":75245,"salesman":"Amjad","routeCode":5,"assignedSUP":123456,"tgt":3300,"actCY":2900,"pctTgt":87.88}];
    masterData=[{"salesmanCode":75241,"routeCode":1,"assignedSUP":123456,"customerCode":"C01","customer":"Aswaq 1","brand":"Rani","productGroup":"RANI FLOAT","subBrand":"FLOAT240ML","product":"RANI PEACH FLOAT-CAN 240MLX24","date":"2026-02-07","actCY":2000,"actLY":6000},{"salesmanCode":75241,"routeCode":1,"assignedSUP":123456,"customerCode":"C01","customer":"Aswaq 1","brand":"Vimto","productGroup":"CORDIAL","subBrand":"CORD 710","product":"VIMTO CORDIAL 710x12","date":"2026-02-07","actCY":700,"actLY":3000},{"salesmanCode":75242,"routeCode":2,"assignedSUP":123456,"customerCode":"C03","customer":"Aswaq 3","brand":"BARBICAN","productGroup":"BBN CAN","subBrand":"BBN CAN APPLE","product":"BARBICAN CAN APPLE 330x6","date":"2026-02-08","actCY":1500,"actLY":2000},{"salesmanCode":75242,"routeCode":2,"assignedSUP":123456,"customerCode":"C03","customer":"Aswaq 3","brand":"Vimto","productGroup":"CORDIAL","subBrand":"CORD 710","product":"VIMTO CORDIAL 710x12","date":"2026-02-08","actCY":1500,"actLY":1000},{"salesmanCode":75243,"routeCode":3,"assignedSUP":123456,"customerCode":"C04","customer":"Aswaq 4","brand":"Rani","productGroup":"RANI FLOAT","subBrand":"FLOAT240ML","product":"RANI PEACH FLOAT-CAN 240MLX24","date":"2026-02-08","actCY":2000,"actLY":1000},{"salesmanCode":75243,"routeCode":3,"assignedSUP":123456,"customerCode":"C04","customer":"Aswaq 4","brand":"BARBICAN","productGroup":"BBN CAN","subBrand":"BBN CAN APPLE","product":"BARBICAN CAN APPLE 330x6","date":"2026-02-09","actCY":800,"actLY":1000},{"salesmanCode":75244,"routeCode":4,"assignedSUP":123456,"customerCode":"C05","customer":"Aswaq 5","brand":"Vimto","productGroup":"CORDIAL","subBrand":"CORD 710","product":"VIMTO CORDIAL 710x12","date":"2026-02-09","actCY":2700,"actLY":2200},{"salesmanCode":75245,"routeCode":5,"assignedSUP":123456,"customerCode":"C06","customer":"Aswaq 6","brand":"Rani","productGroup":"RANI FLOAT","subBrand":"FLOAT240ML","product":"RANI PEACH FLOAT-CAN 240MLX24","date":"2026-02-10","actCY":2900,"actLY":2500}];
    }
}

/* ‚ïê‚ïê TABS ‚ïê‚ïê */
function switchTab(tab){
    const tabs=['salesmen','customers','surveys'];
    document.querySelectorAll('.tab-btn').forEach((b,i)=>{b.classList.toggle('active',i===tabs.indexOf(tab));});
    tabs.forEach(t=>{document.getElementById('tab-'+t).classList.toggle('active',t===tab);});
}

/* ‚ïê‚ïê TAB 1: SALESMEN TABLE ‚ïê‚ïê */
function renderSalesmenTable(){
    const tbody=document.getElementById('salesmenTableBody');
    if(!mySalesmen.length){tbody.innerHTML='<tr><td colspan="8" class="no-data">No salesmen assigned</td></tr>';return;}
    let sorted=[...mySalesmen].map(s=>({...s,remaining:s.tgt-s.actCY}));
    if(smSortField){
        const m=smSortDir==='desc'?-1:1;
        sorted.sort((a,b)=>{const va=a[smSortField],vb=b[smSortField];if(typeof va==='number')return(va-vb)*m;return String(va||'').localeCompare(String(vb||''))*m;});
    }
    let html='',tTgt=0,tAct=0;
    sorted.forEach(s=>{
        const rem=s.tgt-s.actCY;const pct=s.pctTgt;
        const cls=pct>=100?'pct-high':pct>=85?'pct-mid':'pct-low';
        tTgt+=s.tgt;tAct+=s.actCY;
        html+=`<tr>
            <td>${sanitize(s.salesmanCode)}</td><td style="font-weight:600;color:#333">${sanitize(s.salesman)}</td><td>${sanitize(s.routeCode)}</td>
            <td>${s.tgt.toLocaleString()}</td><td class="sales-val">${s.actCY.toLocaleString()}</td>
            <td><span class="pct-badge ${cls}">${pct.toFixed(1)}%</span></td>
            <td>${rem>0?rem.toLocaleString():'‚Äî'}</td>
            <td><div class="mini-progress"><div class="mini-progress-fill" style="width:${Math.min(pct,100)}%"></div></div></td>
        </tr>`;
    });
    tbody.innerHTML=html;
    const oPct=tTgt?((tAct/tTgt)*100):0;
    document.getElementById('smTotalTgt').textContent=tTgt.toLocaleString();
    document.getElementById('smTotalAct').textContent=tAct.toLocaleString();
    document.getElementById('smTotalPct').textContent=oPct.toFixed(1)+'%';
    document.getElementById('smTotalRem').textContent=(tTgt-tAct>0?(tTgt-tAct).toLocaleString():'‚Äî');
    // Update arrows on salesmen table header
    document.querySelectorAll('th.sortable[data-table="sm"]').forEach(th=>{th.classList.remove('sort-asc','sort-desc');if(th.dataset.sort===smSortField)th.classList.add('sort-'+smSortDir);});
}

/* ‚ïê‚ïê TAB 2: CUSTOMERS TABLE (Summary ‚Üí Click to Detail Page) ‚ïê‚ïê */
let custSortField='customer',custSortDir='asc';
let smSortField='',smSortDir='asc';

function getCustomerSummaries(){
    let d=[...myMasterData];
    const q=document.getElementById('custSearch').value.toLowerCase();
    const fS=document.getElementById('filtSalesman').value;
    const fCC=document.getElementById('filtCustCode').value;
    const fC=document.getElementById('filtCustomer').value;
    const fR=document.getElementById('filtRoute').value;
    if(fS)d=d.filter(r=>String(r.salesmanCode)===fS);
    if(fCC)d=d.filter(r=>String(r.customerCode)===fCC);
    if(fC)d=d.filter(r=>r.customer===fC);
    if(fR)d=d.filter(r=>String(r.routeCode)===fR);
    if(q)d=d.filter(r=>[r.customerCode,r.customer,r.brand,r.product,String(r.salesmanCode),String(r.routeCode)].some(v=>String(v).toLowerCase().includes(q)));
    const map={};
    d.forEach(r=>{
        const key=r.customerCode;
        if(!map[key]){const sm=mySalesmen.find(s=>String(s.salesmanCode)==String(r.salesmanCode));map[key]={code:key,name:r.customer,salesman:sm?sm.salesman:String(r.salesmanCode),routeCode:r.routeCode,salesmanCode:r.salesmanCode,totalCY:0,totalLY:0,rows:[]};}
        map[key].totalCY+=(+(+r.actCY)||0);map[key].totalLY+=(+(+r.actLY)||0);map[key].rows.push(r);
    });
    let summaries=Object.values(map);
    summaries.forEach(c=>{c.varPct=c.totalLY?((c.totalCY-c.totalLY)/c.totalLY*100):0;});
    if(custSortField){
        const m=custSortDir==='desc'?-1:1;
        summaries.sort((a,b)=>{
            let va=a[custSortField],vb=b[custSortField];
            if(custSortField==='customer'){va=a.name;vb=b.name;}
            if(typeof va==='number')return(va-vb)*m;
            return String(va||'').localeCompare(String(vb||''))*m;
        });
    }
    return summaries;
}

function openCustomerDetail(code){
    const summaries=getCustomerSummaries();
    const cust=summaries.find(c=>c.code===code);if(!cust)return;
    sessionStorage.setItem('customerDetailInfo',JSON.stringify({
        customerCode:cust.code,customerName:cust.name,salesman:cust.salesman,salesmanCode:cust.salesmanCode,routeCode:cust.routeCode,spvName:currentUser.userName,spvCode:currentUser.userCode,rows:cust.rows
    }));
    window.open('customer_detail.html','_blank');
}

function renderCustTable(){
    const summaries=getCustomerSummaries();
    const tbody=document.getElementById('custTableBody');
    if(!summaries.length){tbody.innerHTML='<tr><td colspan="8" class="no-data">No data found</td></tr>';document.getElementById('custTotalCY').textContent='0';document.getElementById('custTotalLY').textContent='0';return;}
    let html='',tCY=0,tLY=0;
    summaries.forEach(c=>{
        tCY+=c.totalCY;tLY+=c.totalLY;
        const varCls=c.varPct>=0?'var-positive':'var-negative';
        const varStr=(c.varPct>=0?'+':'')+c.varPct.toFixed(1)+'%';
        html+=`<tr class="cust-summary-row" onclick="openCustomerDetail('${sanitize(c.code)}')">
            <td>üîó</td><td style="font-weight:600">${sanitize(c.code)}</td><td style="font-weight:600;color:#333">${sanitize(c.name)}</td>
            <td>${sanitize(c.salesman)}</td><td>${sanitize(c.routeCode)}</td>
            <td class="sales-val">${c.totalCY.toLocaleString()}</td><td>${c.totalLY.toLocaleString()}</td><td><span class="${varCls}">${varStr}</span></td></tr>`;
    });
    tbody.innerHTML=html;document.getElementById('custTotalCY').textContent=tCY.toLocaleString();document.getElementById('custTotalLY').textContent=tLY.toLocaleString();
    updateSortArrows('custTable',custSortField,custSortDir);
}

function populateCustFilters(){
    const fill=(id,vals,lbl)=>{const s=document.getElementById(id);s.innerHTML=`<option value="">All ${lbl}</option>`;vals.forEach(v=>{s.innerHTML+=`<option value="${sanitize(v[0])}">${sanitize(v[1])}</option>`;});};
    const smOpts=mySalesmen.map(s=>[String(s.salesmanCode), `${s.salesman} (${s.salesmanCode})`]);
    fill('filtSalesman',smOpts,'Salesmen');
    fill('filtCustCode',[...new Set(myMasterData.map(r=>r.customerCode))].sort().map(v=>[v,v]),'Codes');
    fill('filtCustomer',[...new Set(myMasterData.map(r=>r.customer))].sort().map(v=>[v,v]),'Customers');
    fill('filtRoute',[...new Set(myMasterData.map(r=>String(r.routeCode)))].sort((a,b)=>Number(a)-Number(b)).map(v=>[v,v]),'Routes');
}

// ‚ïê‚ïê COLUMN SORT UTIL ‚ïê‚ïê
function updateSortArrows(tableId,field,dir){
    const table=document.getElementById(tableId);if(!table)return;
    table.querySelectorAll('th.sortable').forEach(th=>{th.classList.remove('sort-asc','sort-desc');
        if(th.dataset.sort===field)th.classList.add('sort-'+dir);
    });
}

/* ‚ïê‚ïê TAB 3: SURVEYS ‚ïê‚ïê */
async function loadAllSurveys(){
    if(!POWER_AUTOMATE_GET_URL){document.getElementById('surveyTableContainer').innerHTML='<p class="no-data" style="padding:20px">Configure POWER_AUTOMATE_GET_URL to load surveys</p>';return;}
    try{
        document.getElementById('surveyTableContainer').innerHTML='<p class="survey-loading">Loading surveys...</p>';
        const smCodes=mySalesmen.map(s=>String(s.salesmanCode));
        // Include supervisor's own code so surveys created by supervisor are included
        const spvCode=String(currentUser.userCode);
        if(!smCodes.includes(spvCode))smCodes.push(spvCode);
        console.log('Loading surveys for codes:',smCodes);
        const sep=POWER_AUTOMATE_GET_URL.includes('?')?'&':'?';
        const r=await fetch(POWER_AUTOMATE_GET_URL+sep+'t='+Date.now(),{mode:'cors'});
        if(r.ok){
            const data=await r.json();
            console.log('Survey GET response:',JSON.stringify(data).substring(0,500));
            const rows=Array.isArray(data)?data:(data.value||data.rows||[]);
            console.log('Total rows from Excel:',rows.length);
            if(rows.length>0)console.log('Row keys:',Object.keys(rows[0]));
            const g=(row,...keys)=>{for(const k of keys){if(row[k]!==undefined&&row[k]!==null&&String(row[k]).trim())return String(row[k]).trim();}return'';};
            const filtered=rows.filter(row=>{
                const code=g(row,'SalesmanCode','salesmanCode','Salesman Code','salesman_code','salesmancode');
                return smCodes.includes(code);
            });
            console.log('Filtered surveys:',filtered.length);
            allSurveys=filtered.map(row=>({
                customerName:g(row,'CustomerName','customerName','Customer Name'),
                customerCode:g(row,'CustomerCode','customerCode','Customer Code'),
                rating:parseInt(g(row,'Rating','rating'))||0,
                date:parseExcelDate(g(row,'Date','date')),
                time:parseExcelTime(g(row,'Time','time')),
                salesman:g(row,'Salesman','salesman'),
                salesmanCode:g(row,'SalesmanCode','salesmanCode','Salesman Code'),
                photoURLs:['Photo1URL','Photo2URL','Photo3URL','Photo4URL','Photo5URL'].map(k=>row[k]).filter(u=>u&&String(u).trim())
            }));
        }else{console.error('GET not OK:',r.status);}
    }catch(e){console.error('Load surveys error:',e);}
    document.getElementById('sumSurveys').textContent=allSurveys.length;
    populateSurveyFilters();
    renderSurveyTable();
}

function parseExcelDate(val){
    if(!val)return'';
    const s=String(val).trim();
    // Already formatted date string (e.g. "07 Feb 2026" or "2026-02-07")
    if(s.match(/[a-zA-Z]/)|| s.match(/^\d{4}-\d{2}-\d{2}/))return s.replace(/ 00:00:00$/,'');
    const n=Number(s);
    if(!isNaN(n)&&n>30000&&n<100000){
        // Excel serial number
        const d=new Date((n-25569)*86400000);
        return d.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});
    }
    return s;
}

function parseExcelTime(val){
    if(!val)return'';
    const s=String(val).trim();
    // Already formatted time (e.g. "10:32" or "10:32:00")
    if(s.match(/^\d{1,2}:\d{2}/))return s.replace(/:00$/,'');
    const n=Number(s);
    // Fractional day (0.0 - 0.9999)
    if(!isNaN(n)&&n>=0&&n<1){
        const totalMins=Math.round(n*24*60);
        return String(Math.floor(totalMins/60)).padStart(2,'0')+':'+String(totalMins%60).padStart(2,'0');
    }
    // Excel datetime serial (e.g. 46069.438) ‚Äî extract time fraction
    if(!isNaN(n)&&n>30000){
        const frac=n-Math.floor(n);
        if(frac>0){
            const totalMins=Math.round(frac*24*60);
            return String(Math.floor(totalMins/60)).padStart(2,'0')+':'+String(totalMins%60).padStart(2,'0');
        }
    }
    return s;
}

function populateSurveyFilters(){
    const fill=(id,vals,lbl)=>{const s=document.getElementById(id);s.innerHTML=`<option value="">All ${lbl}</option>`;vals.forEach(v=>{s.innerHTML+=`<option value="${sanitize(v[0])}">${sanitize(v[1])}</option>`;});};
    const smOpts=[...new Set(allSurveys.map(s=>s.salesmanCode))].map(c=>{const sv=allSurveys.find(s=>s.salesmanCode==c);return[String(c),sv?sv.salesman+' ('+c+')':String(c)];});
    fill('survFiltSM',smOpts,'Salesmen');
    fill('survFiltCust',[...new Set(allSurveys.map(s=>s.customerName))].sort().map(v=>[v,v]),'Customers');
}

function getSurveyFiltered(){
    const q=document.getElementById('surveySearch').value.toLowerCase();
    const fSM=document.getElementById('survFiltSM').value,fC=document.getElementById('survFiltCust').value,fR=document.getElementById('survFiltRating').value;
    let d=[...allSurveys];
    if(fSM)d=d.filter(s=>String(s.salesmanCode)===fSM);
    if(fC)d=d.filter(s=>s.customerName===fC);
    if(fR==='low')d=d.filter(s=>s.rating>=1&&s.rating<=4);
    else if(fR==='mid')d=d.filter(s=>s.rating>=5&&s.rating<=7);
    else if(fR==='high')d=d.filter(s=>s.rating>=8&&s.rating<=10);
    if(q)d=d.filter(s=>[s.salesman,s.customerName,s.customerCode,s.date].some(v=>String(v).toLowerCase().includes(q)));
    const sv=document.getElementById('survSortBy').value;
    if(sv==='rating-desc')d.sort((a,b)=>b.rating-a.rating);
    else if(sv==='rating-asc')d.sort((a,b)=>a.rating-b.rating);
    else if(sv==='salesman-asc')d.sort((a,b)=>a.salesman.localeCompare(b.salesman));
    else if(sv==='customer-asc')d.sort((a,b)=>a.customerName.localeCompare(b.customerName));
    return d;
}

function renderSurveyTable(){
    const data=getSurveyFiltered();const container=document.getElementById('surveyTableContainer');
    if(!data.length){container.innerHTML='<p class="no-data" style="padding:20px">No surveys found</p>';return;}
    let html='<table class="data-table"><thead><tr><th>Date</th><th>Salesman</th><th>Customer</th><th>Code</th><th>Rating</th><th>Photos</th></tr></thead><tbody>';
    data.forEach(s=>{
        const rCls=s.rating>=8?'pct-high':s.rating>=5?'pct-mid':'pct-low';
        let photoCell=s.photoURLs.length?s.photoURLs.map((u,i)=>'<a href="'+sanitize(u)+'" target="_blank" class="photo-link">Photo '+(i+1)+'</a>').join(''):'<span class="photo-count-badge">0 photos</span>';
        html+=`<tr><td>${sanitize(s.date)}<br><span style="color:#999;font-size:.8em">${sanitize(s.time)}</span></td><td style="font-weight:500">${sanitize(s.salesman)}</td><td style="font-weight:500;color:#333">${sanitize(s.customerName)}</td><td>${sanitize(s.customerCode)}</td><td><span class="pct-badge ${rCls}">${s.rating}/10</span></td><td>${photoCell}</td></tr>`;
    });
    html+='</tbody></table>';
    container.innerHTML=html;
}

/* ‚ïê‚ïê DASHBOARD ‚ïê‚ïê */
function showDashboard(user){
    document.getElementById('loginScreen').style.display='none';
    document.getElementById('dashboard').classList.add('active');
    document.getElementById('dashName').textContent=sanitize(user.userName);
    document.getElementById('dashCode').textContent=sanitize(user.userCode);

    // Filter data for this supervisor
    mySalesmen=salesmenData.filter(s=>s.assignedSUP==user.userCode);
    myMasterData=masterData.filter(r=>r.assignedSUP==user.userCode);

    // Summary
    const tTgt=mySalesmen.reduce((a,s)=>a+s.tgt,0);
    const tAct=mySalesmen.reduce((a,s)=>a+s.actCY,0);
    const uniqueCustomers=[...new Set(myMasterData.map(r=>r.customerCode))];
    document.getElementById('sumSalesmen').textContent=mySalesmen.length;
    document.getElementById('sumTarget').textContent=tTgt.toLocaleString();
    document.getElementById('sumActual').textContent=tAct.toLocaleString();
    document.getElementById('sumPct').textContent=(tTgt?(tAct/tTgt*100):0).toFixed(1)+'%';
    document.getElementById('sumCustomers').textContent=uniqueCustomers.length;

    renderSalesmenTable();
    populateCustFilters();
    renderCustTable();
    loadAllSurveys();
}

/* ‚ïê‚ïê EVENTS ‚ïê‚ïê */
document.addEventListener('DOMContentLoaded',()=>{
    ['custSearch','filtSalesman','filtCustCode','filtCustomer','filtRoute'].forEach(id=>{
        const el=document.getElementById(id);el.addEventListener(el.tagName==='INPUT'?'input':'change',renderCustTable);
    });
    ['surveySearch','survFiltSM','survFiltCust','survFiltRating','survSortBy'].forEach(id=>{
        const el=document.getElementById(id);el.addEventListener(el.tagName==='INPUT'?'input':'change',renderSurveyTable);
    });
    // Column sort click handlers
    document.querySelectorAll('th.sortable').forEach(th=>{
        th.addEventListener('click',function(){
            const field=this.dataset.sort;const table=this.dataset.table||'cust';
            if(table==='sm'){
                if(smSortField===field)smSortDir=smSortDir==='asc'?'desc':'asc';else{smSortField=field;smSortDir='asc';}
                renderSalesmenTable();
            }else{
                if(custSortField===field)custSortDir=custSortDir==='asc'?'desc':'asc';else{custSortField=field;custSortDir='asc';}
                renderCustTable();
            }
        });
    });
});

window.onload=async function(){
    await loadData();
    const s=sessionStorage.getItem('loggedInSupervisor');
    if(s){
        const u=JSON.parse(s);
        console.log('Auto-login from session:',u.userCode);
        // Load fresh data from Apps Script for this user
        if(APPS_SCRIPT_URL){
            const ok=await loadFromAppsScript(u.userCode);
            if(!ok){
                // Apps Script failed ‚Äî user must re-login
                console.log('Apps Script failed, clearing session');
                sessionStorage.removeItem('loggedInSupervisor');
                return;
            }
        }
        const user=usersData.find(x=>String(x.userCode)==String(u.userCode)&&x.role==='Supervisor');
        if(user){
            currentUser=user;showDashboard(user);
            if(window.location.hash==='#tab-customers')switchTab('customers');
        } else {
            sessionStorage.removeItem('loggedInSupervisor');
        }
    }
};

document.getElementById('loginForm').addEventListener('submit',async function(e){
    e.preventDefault();
    const name=document.getElementById('userName').value.trim(),code=document.getElementById('userCode').value.trim();
    if(!name||!code){showError('Please enter both User Name and User ID.');return;}
    const btn=this.querySelector('button[type="submit"]');btn.disabled=true;btn.textContent='Loading...';
    // Try Apps Script first ‚Äî it returns only matching user's data
    let apiOk=false;
    if(APPS_SCRIPT_URL){apiOk=await loadFromAppsScript(code);}
    // Validate: user must match BOTH name AND code
    const user=usersData.find(u=>u.userName.toLowerCase()===name.toLowerCase()&&String(u.userCode)===code);
    btn.disabled=false;btn.textContent='Log In';
    if(!user){showError('Invalid credentials. Check your User Name and User ID.');return;}
    if(user.role!=='Supervisor'){showError('Access Denied: This page is for Supervisor role only.');return;}
    sessionStorage.setItem('loggedInSupervisor',JSON.stringify(user));currentUser=user;showDashboard(user);
});

function showError(m){const e=document.getElementById('errorMessage');e.textContent=m;e.style.display='block';setTimeout(()=>e.style.display='none',3000);}
function logout(){sessionStorage.removeItem('loggedInSupervisor');currentUser=null;document.getElementById('loginForm').reset();document.getElementById('dashboard').classList.remove('active');document.getElementById('loginScreen').style.display='flex';}
</script>
</body>
</html>
